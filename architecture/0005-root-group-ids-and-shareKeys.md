# 5. Root group IDs, `shareKeys` and share link compatibility

Date: 2020-12-03  
Version: 2

## Status

In discussion

## Context

Most maps (v7 and v8) use autogenerated `id` for catalog members - these are used if catalog members don't have an `id` explicitly defined in the catalog.

### Autogenerated IDs (autoIDs)

The root group `id` is very important for share links. By default v8 uses `"/"` and v7 uses `"/Root Group"`

- v7 ID has format `/Root Group/$someContainerId/$someLowerContainerId/$catalogName`
- v8 ID has format `//$someContainerId/$someLowerContainerId/$catalogName`

Using autoIDs solidifies catalog - you can't move items around without changing IDs, which will break share links.

### Catalog converter

Currently, catalog converter will transfer `id`  (only if explicitly defined - i.e. **not autogenerated**) from v7 to v8, and it doesn't write anything to `shareKeys`.

There is a PR - https://github.com/TerriaJS/catalog-converter/pull/28 - to add optional random ID generation.

#### Share conversion (using catalog-converter)

When we convert v7 share JSON to v8 - we convert v7 autoIDs to v8 autoIDs ([see `catalong-converter` share assumptions ADR](https://github.com/TerriaJS/catalog-converter/blob/master/architecture/0001-share-conversion-assumptions.md)) - unless `id` is defined.  

### Static JSON catalog maps (TerriaMap)

If `ids` aren't defined for catalog members, `terriajs` will use autoIDs outlined above.

### Magda map-config

Previously, if a map used a Magda config, the root group ID was `"$magda-config-record-id"`.

As a quick fix, we forced this Magda root group ID to be `"/"` instead of `$magda-config-record-id`. This fixed sharing for Magda JSON/initURL based maps, but broke sharing for Magda catalog maps (not JSON based) - eg digital twins.

#### static JSON/initURL based maps

Magda map-config maps can still use static JSON catalogs (similar to TerriaMap).  

autoIDs are used in the same way. But, if we are using `"$magda-config-record-id"` root group ID, we would see **all** autoIDs change:

- `//$someContainerId/$someLowerContainerId/$catalogName` will become
- `$magda-config-record-id/$someContainerId/$someLowerContainerId/$catalogName`

Thus, breaking share links.

#### Magda catalog maps (not static JSON catalog)

Magda records for each catalog member will always have an explicit ID - for example `41f21ec3-95f8-429a-a62b-44a6183034aa`. Therefore, the changes in autoID outlined above don't apply.  

### ShareKeys

Any change in catalog member IDs across Terria maps will break share links. To overcome this we have `shareKeys`, which acts as a string Map from previous IDs to the current ID.

For example (using Magda static JSON/initURL based maps):

- If `//$someContainerId/$someLowerContainerId/$catalogName` ID is now 
- `$magda-config-record-id/$someContainerId/$someLowerContainerId/$catalogName`

We must set set `shareKeys` to:

- `shareKeys=["//$someContainerId/$someLowerContainerId/$catalogName"]`

**AND** we must also set `shareKeys` for all parent items...

- `$magda-config-record-id/$someContainerId/$someLowerContainerId` -  
  `shareKeys=["//$someContainerId/$someLowerContainerId"]`

- `$magda-config-record-id/$someContainerId` - `shareKeys=["//$someContainerId"]`

- `$magda-config-record-id` - `shareKeys=["/"]`

### Up/Downgrading maps

It is common to move maps between deployment types:

- Static v7 catalog
- Static v8 catalog
- Magda v7-v8 converted JSON-based catalog`*`
- Magda v8 JSON-based catalog`*`
- Magda v8 catalog

`*` indicates on-the-fly conversion - i.e. catalog JSON file is untouched.

These are possible transformations:

- Static v7 -> Static v8
- Static v7 -> Magda v7-v8 converted JSON-based catalog
- Static v8 -> Magda v8 JSON-based catalog
- Static v8 -> Magda v8 catalog
- Magda v8 catalog -> Static v8

#### Static v7 -> Static v8

Approaches:

1. Catalog converter with no IDs
    - Share links converted on the fly using v7 autoIDs -> v8 autoIDs
    - `shareKeys` not required unless catalog structure changes (which would change v8 autoIDs)
2. Catalog converter with new random IDs for each item
    - `shareKeys` must contain v7 autoID to preserve share links
    - Can't re-run catalog converter, as you will get new random IDs

#### Static v7 -> Magda v7-v8 converted JSON-based catalog

Similar to above, but can only use option 1 and requires Magda Reference root group ID to be `/`

#### Static v8 -> Magda v8 JSON-based catalog

Depends on Magda Reference root group ID.

- If we keep it as `/`, then this catalog will behave the same as a Static v8

- If Magda Reference root group ID is reverted to `$magda-config-record-id`, autoIDs will change for every catalog member, therefore `shareKeys` will have to be added to every catalog member to preserve shares.

#### Static v8 -> Magda v8 catalog

When converting to a "Magda catalog", each catalog member is given a new magda record with a new random ID. Therefore, all members will need `shareKeys` with v8 autoIDs (or previous catalog IDs if they were defined).

Changes in Magda Reference root group ID have no effect.

#### Magda v8 catalog -> Static v8

Depends on Magda Reference root group ID.

- If `/`, and magda record IDs are copied into v8 catalog, then share links should work.

- If `$magda-config-record-id`, then `shareKeys` is required for the root group, to translate `$magda-config-record-id` -> `/`

#### Notes on combining transformations

A common scenario will be Static v7 -> Magda v7-v8 converted JSON-based catalog -> Static v8 -> Magda v8 JSON-based catalog -> Magda v8 catalog

If we use `$magda-config-record-id`, then we may have 3 `shareKeys` for each catalog item to deal with.

If we use `/`, then we will only need to deal with adding `shareKeys` for the "Static v8 -> Magda v8 catalog" transformation.

## Decisions: Magda Reference root group ID

We have two options:

- Keeping magda root group as `/`
- Reverting to `$magda-config-record-id`

### Reverting Magda forced group ID

If we revert this, then **ALL** autoIDs for catalog items will change:

- `//$someContainerId/$someLowerContainerId/$catalogName` will become
- `$magda-config-record-id/$someContainerId/$someLowerContainerId/$catalogName`

This means that when we move a catalog into Magda (which gives each catalog item a random ID) we will have 2 `shareKeys` to maintain:

- v7 autoIDs: `/Root Group/$someContainerId/$someLowerContainerId/$catalogName`
- Old magda JSON based autoIDs: `$magda-config-record-id/$someContainerId/$someLowerContainerId/$catalogName`

Also, if we ever change the `$magda-config-record-id` - this will result in a whole new set of IDs that need to be added to `shareKeys` (for Magda JSON-based maps).

In PR - **Unmerged** - https://github.com/TerriaJS/terriajs/pull/5042

#### Catalog-converter

We must then:

- Stop converting autoIDs to v8 in sharelinks - we will keep them as v7 autoIDs.
- Add `shareKeys` with v7 autoIDs.

#### Add `shareKeys` for Magda `map-config` root group

We will have to handle share links which have been generated since the magda root group was changed to `/`. To do so, we must add `"shareKeys": ["/"]` to the root group:

This can be added in the `terria` aspect of the Magda map config record:

```json
{
  "aspects": {
    "terria": {
      "id": "map-config-de-australia",
      "shareKeys": [
        "/"
      ],
      "type": "group"
    },
    ...
  },
  "id": "map-config-de-australia",
  ...
}
```

In PR - **Unmerged** - https://github.com/TerriaJS/terriajs/pull/5042

### Leaving magda root group ID as `/`

Why do we need `$magda-config-record-id` as the root group ID?

#### Catalog-converter

Leaving `"/"` is very convenient - it means we don't need `shareKeys` with our current approach of converting share links (converting v7 autoIDs to v8).  

#### Add `shareKeys` for Magda `map-config` root group

To fix sharelinks which used `$magda-config-record-id` - we need to add `shareKeys=["$magda-config-record-id"]` in the `terria` aspect of the magda map config record (similar to above).

## Consequences

Dragging `shareKeys` around forever :(
