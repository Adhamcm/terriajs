# 5. Root group IDs, `shareKeys` and share link compatibility

Date: 2020-12-03

## Status

In discussion

## Context

The root group `id` is very important for share links. By default v8 uses `"/"` and v7 uses `"/Root Group"`

Most maps (v7 and v8) use auto generated `id` for catalog members:

### Autogenerated IDs

- v7 ID has format `/Root Group/$someContainerId/$someLowerContainerId/$catalogName`
- v8 ID has format `//$someContainerId/$someLowerContainerId/$catalogName`

### Share conversion

Currently when we convert v7 share JSON to v8 - we will convert these autogenerated v7 ids to autogenerated v8 ids ([see `catalong-converter` share assumptions ADR](https://github.com/TerriaJS/catalog-converter/blob/master/architecture/0001-share-conversion-assumptions.md)).

### Magda (JSON/initURL) based maps

If the map uses a Magda config, the root group ID changes from `"/"` to `"$magda-config-record-id"`.

If the map is also using autogenerated IDs, this will result in **all** catalog items having different autogenerated IDs:

- `//$someContainerId/$someLowerContainerId/$catalogName` will become
- `$magda-config-record-id/$someContainerId/$someLowerContainerId/$catalogName`

#### Note on Magda catalogs (not JSON catalog)

Magda records for each catalog item always have an explicit ID - which will be random - for example `41f21ec3-95f8-429a-a62b-44a6183034aa`. Therefore, the changes in ID outlined above don't apply.  

### ShareKeys

Any change in catalog member IDs across maps will break share links. To overcome this we have `shareKeys`, which act as a string Map from previous IDs to the current ID.

For example (using Magda JSON/initURL based maps):

- `//$someContainerId/$someLowerContainerId/$catalogName` ID is now 
- `$magda-config-record-id/$someContainerId/$someLowerContainerId/$catalogName`

So we set `$magda-config-record-id/$someContainerId/$someLowerContainerId/$catalogName` `shareKeys` to:

- `shareKeys=["//$someContainerId/$someLowerContainerId/$catalogName"]`

**BUT** we must also set `shareKeys` for all parent items...

- `$magda-config-record-id/$someContainerId/$someLowerContainerId` -  
  `shareKeys=["//$someContainerId/$someLowerContainerId"]`

- `$magda-config-record-id/$someContainerId` - `shareKeys=["//$someContainerId"]`

- `$magda-config-record-id` - `shareKeys=["/"]`

## Decisions

### Reverting Magda forced group ID

In PR - **Unmerged** - https://github.com/TerriaJS/terriajs/pull/5042

As a quick fix, we forced Magda root group ID to be `"/"` instead of `$magda-config-record-id`. This broke sharing for Magda catalog maps (not JSON based) - eg QLD digital twin.

Why do we need `$magda-config-record-id` as the root group ID?

Leaving `"/"` is very convenient - as it means we don't need `shareKeys` with our current approach of converting share links (converting v7 autogenerated IDs to v8).  
**BUT**, this has broken maps with sharelinks which used `$magda-config-record-id` - therefore we need to add `shareKeys=["$magda-config-record-id"]` in `terria` aspect (see below)

If we revert this, then **ALL** autogenerated IDs for catalog items will change:

- `//$someContainerId/$someLowerContainerId/$catalogName` will become
- `$magda-config-record-id/$someContainerId/$someLowerContainerId/$catalogName`

This means then when we move a catalog into Magda, which gives each catalog item a random ID, we will have 2 `shareKeys` to maintain:

- Autogenerated v7 ID: `/Root Group/$someContainerId/$someLowerContainerId/$catalogName`
- Old magda JSON based ID: `$magda-config-record-id/$someContainerId/$someLowerContainerId/$catalogName`

Also, if we ever change the `$magda-config-record-id` - this will result in a whole new set of IDs that need to be added to `shareKeys` (for Magda JSON-based maps).

### Catalog-converter

If we revert Magda forced group ID - we must then:

- Stop converting autogenerated IDs to v8 in sharelinks - we will keep them as v7 autogenerated ids.
- Add `shareKeys` with v7 autogenerated ids when we convert the catalog.

### Add `shareKeys` for Magda `map-config` root group

In PR - **Unmerged** - https://github.com/TerriaJS/terriajs/pull/5042

These can be added in the `terria` aspect:

```json
{
  "aspects": {
    "terria": {
      "id": "map-config-de-australia",
      "shareKeys": [
        "/"
      ],
      "type": "group"
    },
    ...
  },
  "id": "map-config-de-australia",
  ...
}
```

This can be used to mitigate the "Reverting Magda forced group ID" issue.

## Consequences


